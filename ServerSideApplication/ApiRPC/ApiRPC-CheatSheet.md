# ApiRPC CheatSheet

RPC（Remote Procedure Call），远程过程调用，从最简单最抽象的模式来看，就是下面这个图这样。客户端调用某个方法，然后中间经过一系列的过程，调用到服务端的某个方法。服务端进行处理之后，做出相应，然后逐层原路返回到客户端。

![640](https://user-images.githubusercontent.com/5803001/39872709-72837628-549b-11e8-83a7-2dde4ac41db9.png)

一般来说，开发者只需要关注蓝色（ functions ）部分，而至于红色部分（ stub 句柄 ） 和黄色部分（socket 网络）部分呢，框架层面会把它解决掉。蓝色部分，服务端开发者要做的事情就是定义某个接口，客户端开发者要做的事情就是调用某个接口，一切开发模式都跟本地调用无差别。

# RPC

# WebAPI

# BFF: 用户体验适配层

随着无线技术的发展和各种智能设备的兴起，互联网应用已经从单一 Web 浏览器时代演进到以 API 驱动的无线优先（Mobile First）和面向全渠道体验（omni-channel experience oriented）的时代。

应用架构的新挑战是：

用户接入形式的多样性，无线（手机、Pad），Web，互联网电视，第三方合作应用等等，各种用户设备的屏幕大小，操控体验方式各不相同，例如，手机设备的屏幕较小，能够展示的数据量小，交互方式以触控为主，也可通过条形码扫描器；

有些用户设备的带宽受限，同时应用的 UI 一般宿主在客户端，有些页面需要组合好几个后台业务服务的数据和功能，如果直接在客户端发起对多个后台服务的调用，势必造成大量网络开销影响性能，这个有点类似数据库查询中的 n+1 问题。

BFF（Backend For Frontend）是应对上述应用架构挑战的一种模式和最佳实践，2015 年底，ThoughtWorks 在其网站上刊登了一篇称为 BFF@SoundCloud（SoundCloud 是一个类似音频 YouTube 的网站）的文章[附录 1]，讲述 SoundCloud 如何利用 BFF 模式逐步将其单块 Rails 应用迁移改造为支持无线等多种用户体验的微服务架构。同期，ThoughtWorks 的顾问 Sam Newman，也就是《Building Microservices》那本书的作者，在 SoundCloud 等业界实践的基础上，写了一篇博客总结了 BFF 模式的原理、场景和用法[附录 2]，建议大家阅读。

![640](https://user-images.githubusercontent.com/5803001/39958394-d90d8f42-5634-11e8-9bd7-61925f210d36.png)

BFF 本质上是一个后端中间层，但是它的作用主要是适配前端不同用户体验（无线，桌面，智能终端等等），所以称为用户体验适配层，它的适配作用主要是：

裁剪和格式化，对后台的通用数据模型进行适当的裁剪和格式化，以适应不同的用户体验展示的需要；

聚合编排，对后台服务数据进行编排和预聚合，这样可以有效简化客户端逻辑和减少网络调用开销。

Sam 推荐理想情况下针对每种用户体验类型需要一个 BFF（one BFF per user experience），例如 Mobile BFF，Desktop BFF，这可以做到职责单一和关注分离（遵循有界上下文原则），但是 BFF 过多也会造成代码逻辑重复冗余的问题，需要权衡。UI 和 BFF 理想是同一个团队负责，这样可以减少沟通协调成本，加快变更迭代速度，这是遵循康威定律的体现。下图展示了一种 BFF 和团队职责边界划分方案。

![default](https://user-images.githubusercontent.com/5803001/39958388-bfbe68ae-5634-11e8-97e4-fa4186183522.png)

Sam 还指出，对于一些跨横切面的关注点（cross cutting concerns），例如路由，安全认证，日志监控分析，限流等等，通常可由独立的网关（Gateway）层负责（如 Fig 6 所示），由独立基础设施团队运维，置于 BFF 之前，这样在架构上可以做到职责单一和关注分离，让 BFF 开发人员专注于聚合裁剪等业务功能，无需考虑跨横切面功能。但是如果对运维成本和调用性能有额外考虑，跨横切面的功能也可以直接做在 BFF 一层。
